#!/bin/bash
# Administrative tools for sandbox environment

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

case "${1:-}" in
    reset)
        echo "Resetting sandbox environment..."
        rm -rf "$SCRIPT_DIR/sandbox-repo" "$SCRIPT_DIR/sandbox-worktrees"
        
        echo "Creating fresh sandbox repo..."
        mkdir -p "$SCRIPT_DIR/sandbox-repo"
        cd "$SCRIPT_DIR/sandbox-repo"
        git init -q
        echo "# Test repo" > README.md
        git add README.md
        git commit -q -m "Initial commit"
        
        echo "Initializing multiclaude..."
        export MULTICLAUDE_WORKTREE_DIR="$SCRIPT_DIR/sandbox-worktrees"
        python "$SCRIPT_DIR/multiclaude.py" init
        
        echo "✓ Sandbox reset complete"
        ;;
        
    clean)
        echo "Cleaning worktrees..."
        rm -rf "$SCRIPT_DIR/sandbox-worktrees"
        echo "✓ Worktrees cleaned"
        ;;
        
    status)
        echo "Sandbox status:"
        if [ -d "$SCRIPT_DIR/sandbox-repo" ]; then
            echo "  ✓ sandbox-repo exists"
            if [ -d "$SCRIPT_DIR/sandbox-repo/.multiclaude" ]; then
                echo "  ✓ multiclaude initialized"
            else
                echo "  ✗ multiclaude not initialized (run: $0 reset)"
            fi
        else
            echo "  ✗ sandbox-repo not found (run: $0 reset)"
        fi
        
        if [ -d "$SCRIPT_DIR/sandbox-worktrees" ]; then
            count=$(find "$SCRIPT_DIR/sandbox-worktrees" -mindepth 2 -maxdepth 2 -type d 2>/dev/null | wc -l | tr -d ' ')
            echo "  ✓ $count worktree(s) in sandbox-worktrees"
        else
            echo "  ✓ No worktrees created yet"
        fi
        ;;
        
    *)
        echo "Usage: $0 {reset|clean|status}"
        echo ""
        echo "Commands:"
        echo "  reset   - Delete and recreate sandbox environment"
        echo "  clean   - Remove worktrees only"
        echo "  status  - Show sandbox status"
        ;;
esac